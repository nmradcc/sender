/**
  ******************************************************************************
  * @file    LwIP/LwIP_HTTP_Server_Socket_RTOS/Src/httpserver-socket.c
  * @author  MCD Application Team
  * @version V1.1.0
  * @date    26-June-2014  
  * @brief   Basic http server implementation using LwIP socket API   
  ******************************************************************************
  * @attention
  *
  * <h2><center>&copy; COPYRIGHT(c) 2014 STMicroelectronics</center></h2>
  *
  * Licensed under MCD-ST Liberty SW License Agreement V2, (the "License");
  * You may not use this file except in compliance with the License.
  * You may obtain a copy of the License at:
  *
  *        http://www.st.com/software_license_agreement_liberty_v2
  *
  * Unless required by applicable law or agreed to in writing, software 
  * distributed under the License is distributed on an "AS IS" BASIS, 
  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  * See the License for the specific language governing permissions and
  * limitations under the License.
  *
  ******************************************************************************
  */
  
#include "main.h"
#include "lwip/opt.h"
#include "lwip/arch.h"
#include "lwip/api.h"
#include "lwip/inet.h"
#include "lwip/sockets.h"
//#include "fs.h"
#include "ff.h"
//#include "fsdata.h"
#include "string.h"
//#include "httpserver-socket.h"
//#include "cmsis_os.h"

/* Private typedef -----------------------------------------------------------*/
/* Private define ------------------------------------------------------------*/
//#define WEBSERVER_THREAD_PRIO    ( tskIDLE_PRIORITY + 4 )

/* Private macro -------------------------------------------------------------*/
/* Private variables ---------------------------------------------------------*/
/* Private variables ---------------------------------------------------------*/

// prototype CGI handler for the LED control
const char * LedCGIhandler(int iIndex, int iNumParams, char *pcParam[], char *pcValue[]);

// this structure contains the name of the LED CGI and corresponding handler for the LEDs
//k const tCGI LedCGI={"/leds.cgi", LedCGIhandler};

//table of the CGI names and handlers
// tCGI theCGItable[1];

//The HTTPD functions need a list of the tags contained in the HTML code.
//array of tags for the SSI handler
//these are the tags <!--#tag1--> contained in the shtml file
#define numSSItags 2
char const *theSSItags[numSSItags] = {"tag1","tag2"};


u32_t nPageHits = 0;
portCHAR PAGE_BODY[512];


static const unsigned char PAGE_404[] =
{
};

/* Format of dynamic web page: the page header */
static const unsigned char PAGE_START[] =
{
	0x3c,0x21,0x44,0x4f,0x43,0x54,0x59,0x50,0x45,0x20,0x68,0x74,0x6d,0x6c,0x20,0x50,
	0x55,0x42,0x4c,0x49,0x43,0x20,0x22,0x2d,0x2f,0x2f,0x57,0x33,0x43,0x2f,0x2f,0x44,
	0x54,0x44,0x20,0x48,0x54,0x4d,0x4c,0x20,0x34,0x2e,0x30,0x31,0x2f,0x2f,0x45,0x4e,
	0x22,0x20,0x22,0x68,0x74,0x74,0x70,0x3a,0x2f,0x2f,0x77,0x77,0x77,0x2e,0x77,0x33,
	0x2e,0x6f,0x72,0x67,0x2f,0x54,0x52,0x2f,0x68,0x74,0x6d,0x6c,0x34,0x2f,0x73,0x74,
	0x72,0x69,0x63,0x74,0x2e,0x64,0x74,0x64,0x22,0x3e,0x0d,0x0a,0x3c,0x68,0x74,0x6d,
	0x6c,0x3e,0x0d,0x0a,0x3c,0x68,0x65,0x61,0x64,0x3e,0x0d,0x0a,0x20,0x20,0x3c,0x74,
	0x69,0x74,0x6c,0x65,0x3e,0x53,0x54,0x4d,0x33,0x32,0x46,0x34,0x78,0x78,0x54,0x41,
	0x53,0x4b,0x53,0x3c,0x2f,0x74,0x69,0x74,0x6c,0x65,0x3e,0x0d,0x0a,0x20,0x20,0x3c,
	0x6d,0x65,0x74,0x61,0x20,0x68,0x74,0x74,0x70,0x2d,0x65,0x71,0x75,0x69,0x76,0x3d,
	0x22,0x43,0x6f,0x6e,0x74,0x65,0x6e,0x74,0x2d,0x54,0x79,0x70,0x65,0x22,0x0d,0x0a,
	0x20,0x63,0x6f,0x6e,0x74,0x65,0x6e,0x74,0x3d,0x22,0x74,0x65,0x78,0x74,0x2f,0x68,
	0x74,0x6d,0x6c,0x3b,0x20,0x63,0x68,0x61,0x72,0x73,0x65,0x74,0x3d,0x77,0x69,0x6e,
	0x64,0x6f,0x77,0x73,0x2d,0x31,0x32,0x35,0x32,0x22,0x3e,0x0d,0x0a,0x20,0x20,0x3c,
	0x6d,0x65,0x74,0x61,0x20,0x68,0x74,0x74,0x70,0x2d,0x65,0x71,0x75,0x69,0x76,0x3d,
	0x22,0x72,0x65,0x66,0x72,0x65,0x73,0x68,0x22,0x20,0x63,0x6f,0x6e,0x74,0x65,0x6e,
	0x74,0x3d,0x22,0x31,0x22,0x3e,0x0d,0x0a,0x20,0x20,0x3c,0x6d,0x65,0x74,0x61,0x20,
	0x63,0x6f,0x6e,0x74,0x65,0x6e,0x74,0x3d,0x22,0x4d,0x53,0x48,0x54,0x4d,0x4c,0x20,
	0x36,0x2e,0x30,0x30,0x2e,0x32,0x38,0x30,0x30,0x2e,0x31,0x35,0x36,0x31,0x22,0x20,
	0x6e,0x61,0x6d,0x65,0x3d,0x22,0x47,0x45,0x4e,0x45,0x52,0x41,0x54,0x4f,0x52,0x22,
	0x3e,0x0d,0x0a,0x20,0x20,0x3c,0x73,0x74,0x79,0x6c,0x65,0x20,0x3d,0x22,0x66,0x6f,
	0x6e,0x74,0x2d,0x77,0x65,0x69,0x67,0x68,0x74,0x3a,0x20,0x6e,0x6f,0x72,0x6d,0x61,
	0x6c,0x3b,0x20,0x66,0x6f,0x6e,0x74,0x2d,0x66,0x61,0x6d,0x69,0x6c,0x79,0x3a,0x20,
	0x56,0x65,0x72,0x64,0x61,0x6e,0x61,0x3b,0x22,0x3e,0x3c,0x2f,0x73,0x74,0x79,0x6c,
	0x65,0x3e,0x0d,0x0a,0x3c,0x2f,0x68,0x65,0x61,0x64,0x3e,0x0d,0x0a,0x3c,0x62,0x6f,
	0x64,0x79,0x3e,0x0d,0x0a,0x3c,0x68,0x34,0x3e,0x3c,0x73,0x6d,0x61,0x6c,0x6c,0x20,
	0x73,0x74,0x79,0x6c,0x65,0x3d,0x22,0x66,0x6f,0x6e,0x74,0x2d,0x66,0x61,0x6d,0x69,
	0x6c,0x79,0x3a,0x20,0x56,0x65,0x72,0x64,0x61,0x6e,0x61,0x3b,0x22,0x3e,0x3c,0x73,
	0x6d,0x61,0x6c,0x6c,0x3e,0x3c,0x62,0x69,0x67,0x3e,0x3c,0x62,0x69,0x67,0x3e,0x3c,
	0x62,0x69,0x67,0x0d,0x0a,0x20,0x73,0x74,0x79,0x6c,0x65,0x3d,0x22,0x66,0x6f,0x6e,
	0x74,0x2d,0x77,0x65,0x69,0x67,0x68,0x74,0x3a,0x20,0x62,0x6f,0x6c,0x64,0x3b,0x22,
	0x3e,0x3c,0x62,0x69,0x67,0x3e,0x3c,0x73,0x74,0x72,0x6f,0x6e,0x67,0x3e,0x3c,0x65,
	0x6d,0x3e,0x3c,0x73,0x70,0x61,0x6e,0x0d,0x0a,0x20,0x73,0x74,0x79,0x6c,0x65,0x3d,
	0x22,0x66,0x6f,0x6e,0x74,0x2d,0x73,0x74,0x79,0x6c,0x65,0x3a,0x20,0x69,0x74,0x61,
	0x6c,0x69,0x63,0x3b,0x22,0x3e,0x53,0x54,0x4d,0x33,0x32,0x46,0x34,0x78,0x78,0x20,
	0x4c,0x69,0x73,0x74,0x20,0x6f,0x66,0x20,0x74,0x61,0x73,0x6b,0x73,0x20,0x61,0x6e,
	0x64,0x0d,0x0a,0x74,0x68,0x65,0x69,0x72,0x20,0x73,0x74,0x61,0x74,0x75,0x73,0x3c,
	0x2f,0x73,0x70,0x61,0x6e,0x3e,0x3c,0x2f,0x65,0x6d,0x3e,0x3c,0x2f,0x73,0x74,0x72,
	0x6f,0x6e,0x67,0x3e,0x3c,0x2f,0x62,0x69,0x67,0x3e,0x3c,0x2f,0x62,0x69,0x67,0x3e,
	0x3c,0x2f,0x62,0x69,0x67,0x3e,0x3c,0x2f,0x62,0x69,0x67,0x3e,0x3c,0x2f,0x73,0x6d,
	0x61,0x6c,0x6c,0x3e,0x3c,0x2f,0x73,0x6d,0x61,0x6c,0x6c,0x3e,0x3c,0x2f,0x68,0x34,
	0x3e,0x0d,0x0a,0x3c,0x68,0x72,0x20,0x73,0x74,0x79,0x6c,0x65,0x3d,0x22,0x77,0x69,
	0x64,0x74,0x68,0x3a,0x20,0x31,0x30,0x30,0x25,0x3b,0x20,0x68,0x65,0x69,0x67,0x68,
	0x74,0x3a,0x20,0x32,0x70,0x78,0x3b,0x22,0x3e,0x3c,0x73,0x70,0x61,0x6e,0x0d,0x0a,
	0x20,0x73,0x74,0x79,0x6c,0x65,0x3d,0x22,0x66,0x6f,0x6e,0x74,0x2d,0x77,0x65,0x69,
	0x67,0x68,0x74,0x3a,0x20,0x62,0x6f,0x6c,0x64,0x3b,0x22,0x3e,0x0d,0x0a,0x3c,0x2f,
	0x73,0x70,0x61,0x6e,0x3e,0x3c,0x73,0x70,0x61,0x6e,0x20,0x73,0x74,0x79,0x6c,0x65,
	0x3d,0x22,0x66,0x6f,0x6e,0x74,0x2d,0x77,0x65,0x69,0x67,0x68,0x74,0x3a,0x20,0x62,
	0x6f,0x6c,0x64,0x3b,0x22,0x3e,0x0d,0x0a,0x3c,0x74,0x61,0x62,0x6c,0x65,0x20,0x73,
	0x74,0x79,0x6c,0x65,0x3d,0x22,0x77,0x69,0x64,0x74,0x68,0x3a,0x20,0x39,0x36,0x31,
	0x70,0x78,0x3b,0x20,0x68,0x65,0x69,0x67,0x68,0x74,0x3a,0x20,0x33,0x30,0x70,0x78,
	0x3b,0x22,0x20,0x62,0x6f,0x72,0x64,0x65,0x72,0x3d,0x22,0x31,0x22,0x0d,0x0a,0x20,
	0x63,0x65,0x6c,0x6c,0x70,0x61,0x64,0x64,0x69,0x6e,0x67,0x3d,0x22,0x32,0x22,0x20,
	0x63,0x65,0x6c,0x6c,0x73,0x70,0x61,0x63,0x69,0x6e,0x67,0x3d,0x22,0x32,0x22,0x3e,
	0x0d,0x0a,0x20,0x20,0x3c,0x74,0x62,0x6f,0x64,0x79,0x3e,0x0d,0x0a,0x20,0x20,0x20,
	0x20,0x3c,0x74,0x72,0x3e,0x0d,0x0a,0x20,0x20,0x20,0x20,0x20,0x20,0x3c,0x74,0x64,
	0x0d,0x0a,0x20,0x73,0x74,0x79,0x6c,0x65,0x3d,0x22,0x66,0x6f,0x6e,0x74,0x2d,0x66,
	0x61,0x6d,0x69,0x6c,0x79,0x3a,0x20,0x56,0x65,0x72,0x64,0x61,0x6e,0x61,0x3b,0x20,
	0x66,0x6f,0x6e,0x74,0x2d,0x77,0x65,0x69,0x67,0x68,0x74,0x3a,0x20,0x62,0x6f,0x6c,
	0x64,0x3b,0x20,0x66,0x6f,0x6e,0x74,0x2d,0x73,0x74,0x79,0x6c,0x65,0x3a,0x20,0x69,
	0x74,0x61,0x6c,0x69,0x63,0x3b,0x20,0x62,0x61,0x63,0x6b,0x67,0x72,0x6f,0x75,0x6e,
	0x64,0x2d,0x63,0x6f,0x6c,0x6f,0x72,0x3a,0x20,0x72,0x67,0x62,0x28,0x35,0x31,0x2c,
	0x20,0x35,0x31,0x2c,0x20,0x32,0x35,0x35,0x29,0x3b,0x20,0x74,0x65,0x78,0x74,0x2d,
	0x61,0x6c,0x69,0x67,0x6e,0x3a,0x20,0x63,0x65,0x6e,0x74,0x65,0x72,0x3b,0x22,0x3e,
	0x3c,0x73,0x6d,0x61,0x6c,0x6c,0x3e,0x3c,0x61,0x0d,0x0a,0x20,0x68,0x72,0x65,0x66,
	0x3d,0x22,0x2f,0x53,0x54,0x4d,0x33,0x32,0x46,0x34,0x78,0x78,0x2e,0x68,0x74,0x6d,
	0x6c,0x22,0x3e,0x3c,0x73,0x70,0x61,0x6e,0x20,0x73,0x74,0x79,0x6c,0x65,0x3d,0x22,
	0x63,0x6f,0x6c,0x6f,0x72,0x3a,0x20,0x77,0x68,0x69,0x74,0x65,0x3b,0x22,0x3e,0x48,
	0x6f,0x6d,0x65,0x0d,0x0a,0x70,0x61,0x67,0x65,0x3c,0x2f,0x73,0x70,0x61,0x6e,0x3e,
	0x3c,0x2f,0x61,0x3e,0x3c,0x2f,0x73,0x6d,0x61,0x6c,0x6c,0x3e,0x3c,0x2f,0x74,0x64,
	0x3e,0x0d,0x0a,0x20,0x20,0x20,0x20,0x20,0x20,0x3c,0x74,0x64,0x0d,0x0a,0x20,0x73,
	0x74,0x79,0x6c,0x65,0x3d,0x22,0x66,0x6f,0x6e,0x74,0x2d,0x66,0x61,0x6d,0x69,0x6c,
	0x79,0x3a,0x20,0x56,0x65,0x72,0x64,0x61,0x6e,0x61,0x3b,0x20,0x66,0x6f,0x6e,0x74,
	0x2d,0x77,0x65,0x69,0x67,0x68,0x74,0x3a,0x20,0x62,0x6f,0x6c,0x64,0x3b,0x20,0x66,
	0x6f,0x6e,0x74,0x2d,0x73,0x74,0x79,0x6c,0x65,0x3a,0x20,0x69,0x74,0x61,0x6c,0x69,
	0x63,0x3b,0x20,0x62,0x61,0x63,0x6b,0x67,0x72,0x6f,0x75,0x6e,0x64,0x2d,0x63,0x6f,
	0x6c,0x6f,0x72,0x3a,0x20,0x72,0x67,0x62,0x28,0x35,0x31,0x2c,0x20,0x35,0x31,0x2c,
	0x20,0x32,0x35,0x35,0x29,0x3b,0x20,0x74,0x65,0x78,0x74,0x2d,0x61,0x6c,0x69,0x67,
	0x6e,0x3a,0x20,0x63,0x65,0x6e,0x74,0x65,0x72,0x3b,0x22,0x3e,0x3c,0x61,0x0d,0x0a,
	0x20,0x68,0x72,0x65,0x66,0x3d,0x22,0x53,0x54,0x4d,0x33,0x32,0x46,0x34,0x78,0x78,
	0x41,0x44,0x43,0x2e,0x68,0x74,0x6d,0x6c,0x22,0x3e,0x3c,0x73,0x70,0x61,0x6e,0x20,
	0x73,0x74,0x79,0x6c,0x65,0x3d,0x22,0x66,0x6f,0x6e,0x74,0x2d,0x77,0x65,0x69,0x67,
	0x68,0x74,0x3a,0x20,0x62,0x6f,0x6c,0x64,0x3b,0x22,0x3e,0x3c,0x2f,0x73,0x70,0x61,
	0x6e,0x3e,0x3c,0x2f,0x61,0x3e,0x3c,0x73,0x6d,0x61,0x6c,0x6c,0x3e,0x3c,0x61,0x0d,
	0x0a,0x20,0x68,0x72,0x65,0x66,0x3d,0x22,0x2f,0x53,0x54,0x4d,0x33,0x32,0x46,0x34,
	0x78,0x78,0x54,0x41,0x53,0x4b,0x53,0x2e,0x68,0x74,0x6d,0x6c,0x22,0x3e,0x3c,0x73,
	0x70,0x61,0x6e,0x20,0x73,0x74,0x79,0x6c,0x65,0x3d,0x22,0x63,0x6f,0x6c,0x6f,0x72,
	0x3a,0x20,0x77,0x68,0x69,0x74,0x65,0x3b,0x22,0x3e,0x4c,0x69,0x73,0x74,0x0d,0x0a,
	0x6f,0x66,0x20,0x74,0x61,0x73,0x6b,0x73,0x3c,0x2f,0x73,0x70,0x61,0x6e,0x3e,0x3c,
	0x2f,0x61,0x3e,0x3c,0x2f,0x73,0x6d,0x61,0x6c,0x6c,0x3e,0x3c,0x2f,0x74,0x64,0x3e,
	0x0d,0x0a,0x20,0x20,0x20,0x20,0x3c,0x2f,0x74,0x72,0x3e,0x0d,0x0a,0x20,0x20,0x3c,
	0x2f,0x74,0x62,0x6f,0x64,0x79,0x3e,0x0d,0x0a,0x3c,0x2f,0x74,0x61,0x62,0x6c,0x65,
	0x3e,0x0d,0x0a,0x3c,0x62,0x72,0x3e,0x0d,0x0a,0x3c,0x2f,0x73,0x70,0x61,0x6e,0x3e,
	0x3c,0x73,0x70,0x61,0x6e,0x20,0x73,0x74,0x79,0x6c,0x65,0x3d,0x22,0x66,0x6f,0x6e,
	0x74,0x2d,0x77,0x65,0x69,0x67,0x68,0x74,0x3a,0x20,0x62,0x6f,0x6c,0x64,0x3b,0x22,
	0x3e,0x3c,0x2f,0x73,0x70,0x61,0x6e,0x3e,0x3c,0x73,0x6d,0x61,0x6c,0x6c,0x3e,0x3c,
	0x73,0x70,0x61,0x6e,0x0d,0x0a,0x20,0x73,0x74,0x79,0x6c,0x65,0x3d,0x22,0x66,0x6f,
	0x6e,0x74,0x2d,0x66,0x61,0x6d,0x69,0x6c,0x79,0x3a,0x20,0x56,0x65,0x72,0x64,0x61,
	0x6e,0x61,0x3b,0x22,0x3e,0x4e,0x75,0x6d,0x62,0x65,0x72,0x20,0x6f,0x66,0x20,0x70,
	0x61,0x67,0x65,0x20,0x68,0x69,0x74,0x73,0x3a,0x0d,0x0a,0x00
};


static const char PAGE_START2[] = "<!DOCTYPE html PUBLIC \"-//W3C//DTD HTML 4.01//EN\" \"http://www.w3.org/TR/html4/strict.dtd\">\r\n \
<html>\r\n \
<head>\r\n \
 <title>STM32F4xxTASKS</title>\r\n \
 <meta http-equiv=\"Content-Type\"\r\n \
 content=\"text/html; charset=windows-1252\">\r\n \
 <meta http-equiv=\"refresh\" content=\"1\">\r\n \
 <meta content=\"MSHTML 6.00.2800.1561\" name=\"GENERATOR\">\r\n \
 <style =\"font-weight: normal; font-family: Verdana;\"></style>\r\n \
</head>\r\n \
<body>\r\n \
<h4><small style=\"font-family: Verdana;\"><small><big><big><big\r\n \
 style=\"font-weight: bold;\"><big><strong><em><span\r\n \
 style=\"font-style: italic;\">STM32F4xx List of tasks and their status</span></em></strong></big></big></big></big></small></small></h4>\r\n \
<hr style=\"width: 100%; height: 2px;\"><span\r\n \
 style=\"font-weight: bold;\">\r\n \
</span><span style=\"font-weight: bold;\">\r\n \
<table style=\"width: 961px; height: 30px;\" border=\"1\"\r\n \
 cellpadding=\"2\" cellspacing=\"2\">\r\n \
  <tbody>\r\n \
    <tr>\r\n \
      <td\r\n \
 style=\"font-family: Verdana; font-weight: bold; font-style: italic; background-color: rgb(51, 51, 255); text-align: center;\"><small><a\r\n \
 href=\"/STM32F4xx.html\"><span style=\"color: white;\">Home page</span></a></small></td>\r\n \
      <td\r\n \
 style=\"font-family: Verdana; font-weight: bold; font-style: italic; background-color: rgb(51, 51, 255); text-align: center;\"><a\r\n \
 href=\"STM32F4xxADC.html\"><span style=\"font-weight: bold;\"></span></a><small><a\r\n \
 href=\"/STM32F4xxTASKS.html\"><span style=\"color: white;\">List of tasks</span></a></small></td>\r\n \
    </tr>\r\n \
  </tbody>\r\n \
</table>\r\n \
<br>\r\n \
</span><span style=\"font-weight: bold;\"></span><small><span\r\n \
 style=\"font-family: Verdana;\">Number of page hits:\r\n";


static const char SSI_PAGE_START[] = "<!DOCTYPE html> \
<html><head><title>LED Test</title> \
<body> \
<p>This allows you to control the LEDs: LED1 and LED2. You have to click on \"Send\" button to change the LEDs</p> \
<form method=\"get\" action=\"/leds.cgi\"> \
<input value=\"1\" name=\"led\" type=\"checkbox\">LED1<br> \
<input value=\"2\" name=\"led\" type=\"checkbox\">LED2<br> \
<br> \
<p>text for tag1: <!--#tag1--></p> \
<p>text for tag2: <!--#tag2--></p> \
<input value=\"Send\" type=\"submit\"> </form> \
</body></html>";


/* Private function prototypes -----------------------------------------------*/
extern char* strsep(char **stringp, const char *delim);

void DynWebPage(int conn);
void SSIWebPage(int conn);

/* Private functions ---------------------------------------------------------*/

/**
  * @brief serve tcp connection  
  * @param conn: connection socket 
  * @retval None
  */
void http_server_serve(int conn) 
{
	int buflen = 1500;
	int ret;
	uint len;
	FIL file;
	/* unsigned */ char recv_buffer[1500];
	char* pCmd;
	char* pFile;
	char ReadBuf[1500];
	char* pBuf = recv_buffer;

	/* Read in the request */
	ret = read(conn, recv_buffer, buflen);
	if(ret < 0) return;


	pCmd = strsep(&pBuf, " ");
	pFile = strsep(&pBuf, " ");

	if(strcmp(pCmd, "GET") == 0)
	{
		if(strcmp(pFile, "/TASKS.html") == 0)
		{
			DynWebPage(conn);
		}
		else if(strcmp(pFile, "/STATUS.shtml") == 0)
		{
			SSIWebPage(conn);
		}
		else if(f_open (&file, pFile, FA_READ) ==  FR_OK)
		{
			do
			{
				//read the file in chunks and send it out
				if(f_read(&file, ReadBuf, 1500, &len) == FR_OK)
				{
					write(conn, (const unsigned char*)(ReadBuf), len);
				}
				f_close(&file);
			} while(len == 1500);
		}
		else
		{
			//if(fs_open (&file, "/404.html", "r") ==  FR_OK)
			//{
			//k	write(conn, (const unsigned char*)(file->data), (size_t)file->len);
			//	fs_close(file);
			//}

			write(conn, PAGE_404, strlen((char*)PAGE_404));

		}
	}

  /* Close connection socket */
  close(conn);
}

/**
  * @brief  http server thread 
  * @param arg: pointer on argument(not used here) 
  * @retval None
  */
static void http_server_socket_thread(void *arg)
{
	int sock, newconn, size;
	struct sockaddr_in address, remotehost;

	/* create a TCP socket */
	if ((sock = socket(AF_INET, SOCK_STREAM, 0)) < 0)
	{
		return;
	}

	/* bind to port 80 at any interface */
	address.sin_family = AF_INET;
	address.sin_port = htons(80);
	address.sin_addr.s_addr = INADDR_ANY;

	if (bind(sock, (struct sockaddr *)&address, sizeof (address)) < 0)
	{
		return;
	}

	/* listen for incoming connections (TCP listen backlog = 5) */
	listen(sock, 5);

	size = sizeof(remotehost);

	while (1)
	{
		newconn = accept(sock, (struct sockaddr *)&remotehost, (socklen_t *)&size);
		http_server_serve(newconn);
	}
}



// Initialize the CGI handlers
void myCGIinit(void)
{
	//add LED control CGI to the table
//k	theCGItable[0] = LedCGI;
	//give the table to the HTTP server
//k	http_set_cgi_handlers(theCGItable, 1);
} //myCGIinit


/**
  * @brief  Initialize the HTTP server (start its thread) 
  * @param  none
  * @retval None
  */
void http_server_socket_init()
{

	//initialise the CGI handlers
	myCGIinit();

	//k  sys_thread_new("HTTP", http_server_socket_thread, NULL, DEFAULT_THREAD_STACKSIZE * 2, WEBSERVER_THREAD_PRIO);
	const osThreadAttr_t webServerTask_attributes = {
	  .name = "webServerTask",
	  .priority = (osPriority_t) osPriorityAboveNormal,
	  .stack_size = 512
	};
	osThreadNew(http_server_socket_thread, NULL, &webServerTask_attributes);
}

/**
  * @brief  Create and send a dynamic Web Page. This page contains the list of 
  *         running tasks and the number of page hits. 
  * @param  conn connection socket
  * @retval None
  */



void AddField(char* szInBuffer, char* szOutBuffer, int iFieldWidth)
{
	int iLen;

	iLen = strlen(szInBuffer);

	strcat(szOutBuffer, szInBuffer);

	while(iLen < iFieldWidth)
	{
		strcat(szOutBuffer, " ");
		iFieldWidth--;
	}
}

void AddFieldNumber(char* szOutBuffer, int number, int iFieldWidth)
{
	char num[10];

	itoa(number, num, 10);
	AddField(num, szOutBuffer, iFieldWidth);
}


void DynWebPage(int conn)
{
	osThreadId_t ThreadIds[20];
	uint32_t Threads;
	uint32_t State;
	char Status[2];
	portCHAR pagehits[10];

	memset(PAGE_BODY, 0, 512);

	/* Update the hit count */
	nPageHits++;
	sprintf( pagehits, "%d", (int)nPageHits );
	strcat(PAGE_BODY, pagehits);
	strcat((char *) PAGE_BODY, "<pre><br>Name            State Priority  Stack Space" );
	strcat((char *) PAGE_BODY, "<br>-------------------------------------------<br>");

	/* The list of tasks and their status */
	Threads = osThreadEnumerate (ThreadIds, 20);

	for(int i = 0; i < Threads; i++)
	{

		AddField((char *) PAGE_BODY, (char*)osThreadGetName (ThreadIds[i]), 16);

		// print the status
		State = osThreadGetState (ThreadIds[i]);
		Status[1] = 0;
		switch( State )
		{
			case osThreadInactive:
				Status[0] = 'I';
			break;

			case osThreadReady:
				Status[0] = 'X';
			break;

			case osThreadRunning:
				Status[0] = 'R';
			break;

			case osThreadBlocked:
				Status[0] = 'B';
			break;

			case osThreadTerminated:
				Status[0] = 'T';
			break;

			case osThreadError:
				Status[0] = 'E';
			break;

			default:			/* Should not get here, but it is included to prevent static checking errors. */
				Status[0] = 0;
			break;
		}
		AddField((char *) PAGE_BODY, Status, 6);

		AddFieldNumber((char *) PAGE_BODY, osThreadGetPriority (ThreadIds[i]), 10);

		AddFieldNumber((char *) PAGE_BODY, osThreadGetStackSize (ThreadIds[i]), 6);

		AddFieldNumber((char *) PAGE_BODY, osThreadGetStackSpace (ThreadIds[i]), 6);
	}


	strcat((char *) PAGE_BODY, "<br>-------------------------------------------<br>");
	strcat((char *) PAGE_BODY, "<br>I: Inactive, B: Blocked, X: Ready, R: Running, T: Terminated, E: Error<br>");

	/* Send the dynamically generated page */
	write(conn, PAGE_START, strlen((char*)PAGE_START));
	write(conn, PAGE_BODY, strlen(PAGE_BODY));
}



void SSIWebPage(int conn)
{
	portCHAR pagehits[10];

	memset(PAGE_BODY, 0, 512);

	/* Update the hit count */
	nPageHits++;
	sprintf( pagehits, "%d", (int)nPageHits );
	strcat(PAGE_BODY, pagehits);

	/* Send the dynamically generated page */
	write(conn, SSI_PAGE_START, strlen((char*)SSI_PAGE_START));
	write(conn, PAGE_BODY, strlen(PAGE_BODY));
}


/**** CGI handler for controlling the LEDs ****/
// the function pointer for a CGI script handler is defined in httpd.h as tCGIHandler
const char * LedCGIhandler(int iIndex, int iNumParams, char *pcParam[], char *pcValue[])
{
	uint32_t i=0;
	// index of the CGI within the theCGItable array passed to http_set_cgi_handlers
	// Given how this example is structured, this may be a redundant check.
	// Here there is only one handler iIndex == 0
	if (iIndex == 0)
	{
		// turn off the LEDs
//		HAL_GPIO_WritePin(LD3_GPIO_Port, LD2_Pin, GPIO_PIN_RESET);
//		HAL_GPIO_WritePin(LD3_GPIO_Port, LD3_Pin, GPIO_PIN_RESET);
		// Check the cgi parameters, e.g., GET /leds.cgi?led=1&led=2
		for (i=0; i<iNumParams; i++)
		{
			//if pcParmeter contains "led", then one of the LED check boxes has been set on
			if (strcmp(pcParam[i], "led") == 0)
			{
				//see if checkbox for LED 1 has been set
				if(strcmp(pcValue[i], "1") == 0)
				{
					// switch led 1 ON if 1
//					HAL_GPIO_WritePin(LD3_GPIO_Port, LD2_Pin, GPIO_PIN_SET);
				}
				//see if checkbox for LED 2 has been set
				else if(strcmp(pcValue[i], "2") == 0)
				{
					// switch led 2 ON if 2
//					HAL_GPIO_WritePin(LD3_GPIO_Port, LD3_Pin, GPIO_PIN_SET);
				}
			} //if
		} //for
	} //if
	//uniform resource identifier to send after CGI call, i.e., path and filename of the response
	return "/index.html";
}


// <!--#name-->



/**** SSI handler ****/
// This function is called each time the HTTPD server detects a tag of the form
// <!--#name--> in a .shtml, .ssi or .shtm file
// It won't work if the file has a .html extension.
u16_t mySSIHandler(int iIndex, char *pcInsert, int iInsertLen)
{
	// see which tag in the array theSSItags to handle
	if (iIndex == 0) //is “tag1”
	{
		char myStr1[] = "Hello from Tag #1!"; //string to be displayed on web page
		//copy the string to be displayed to pcInsert
		strcpy(pcInsert, myStr1);
		//return number of characters that need to be inserted in html
		return strlen(myStr1);
	}
	else if (iIndex == 1) //is “tag2”
	{
		char myStr2[] = "Hello from Tag #2!"; //string to be displayed on web page
		//copy string to be displayed
		strcpy(pcInsert, myStr2);
		//return number of characters that need to be inserted in html
		return strlen(myStr2);
	}
	return 0;
} //mySSIHandler


void mySSIinit(void)
{
	//configure SSI handler function
	//theSSItags is an array of SSI tag strings to search for in SSI-enabled files
//	http_set_ssi_handler(mySSIHandler, (char const **)theSSItags, numSSItags);
} //mySSIinit




/************************ (C) COPYRIGHT STMicroelectronics *****END OF FILE****/

